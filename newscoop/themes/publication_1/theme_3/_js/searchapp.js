var Document=Backbone.Model.extend({day:86400,month:2592E3,year:31536E3,types:{news:"omni",newswire:"article",dossier:"dossier",user:"user",tweet:"twitter",event:"event",comment:"comment",link:"link",blog:"omni"},relDate:function(a){a=new Date(this.get(a));a=Math.ceil(Math.abs((new Date).getTime()-a.getTime())/1E3);if(60>a)return"vor "+a+" Sek.";if(3600>a)return"vor "+(a/60).toFixed()+" Min.";if(a<this.day)return"vor "+(a/3600).toFixed()+" Std.";if(a<this.month)return a=(a/this.day).toFixed(),"vor "+
a+" "+(1==a?"Tag":"Tagen");if(a<this.year)return a=(a/this.month).toFixed(),"vor "+a+" "+(1==a?"Monat":"Monaten");a=(a/this.year).toFixed();return"vor "+a+" "+(1==a?"Jahr":"Jahren")},getTemplateType:function(){if(!this.get("type")in this.types)console.log(this.get("type"));else return this.types[this.get("type")]},getTweet:function(){var a=this.get("tweet");return!a?a:a.replace(/(http:\/\/t.co\/[\w]+)/,'<a href="$1" rel="nofollow" target="_blank">$1</a>')},getEventDate:function(){return this.get("event_date")?
this.get("event_date"):""},getEventTime:function(){return this.get("event_time")?this.get("event_time")+" Uhr":""},getEventTitle:function(){return this.escape("title").replace(/ \([-0-9]+\)$/,"")}}),DocumentCollection=Backbone.Collection.extend({model:Document,topics:{},buildParams:function(){var a={};this.query&&(a.q=this.query);this.type&&(a.type=this.type);this.date&&(a.date=this.date);this.start&&(a.start=this.start);this.sortf&&(a.sort=this.sortf);this.source&&(a.source=this.source);this.section&&
(a.section=this.section);this.topics.length&&(a.topic=this.topics.join());return a},url:function(){var a=this.buildParams();a.format="json";return"?"+jQuery.param(a)},nav:function(){var a=this.buildParams();return"?"+jQuery.param(a)},parse:function(a){this.response=a;this.query=a.responseHeader.params.q;this.count=parseInt(a.response.numFound);this.start=parseInt(a.response.start);this.rows=parseInt(a.responseHeader.params.rows);this.type=a.responseHeader.params.type;this.date=a.responseHeader.params.date;
this.source=a.responseHeader.params.source;this.section=a.responseHeader.params.section;this.facets=this.parseFacetFields(a);this.sortf=a.responseHeader.params.sort;this.topics=a.responseHeader.params.topic;return a.response.docs},hasSuggestion:function(){return this.response.spellcheck&&0!==this.response.spellcheck.suggestions.length},getSuggestion:function(){return this.response.spellcheck.suggestions[3]},parseFacetFields:function(a){if(!a.facet_counts)return{};for(var b={},a=a.facet_counts.facet_fields.type?
a.facet_counts.facet_fields.type:a.facet_counts.facet_fields.section,c=0;c<a.length;c+=2)b[a[c]]=a[c+1];b.article=b.news+b.newswire;return b},toggleTopic:function(a){var b=_.indexOf(this.topics,a);-1!==b?this.topics.splice(b,1):this.topics.push(a)}}),DocumentView=Backbone.View.extend({tagName:"li",initialize:function(){this.template=_.template($("#document-"+this.model.getTemplateType()+"-template").html())},render:function(){$(this.el).html(this.template({doc:this.model})).addClass(this.model.getTemplateType());
return this}}),SearchFormView=Backbone.View.extend({events:{"blur input":"search","click button":"search",send:"search"},webcode:/^[\+\@][a-z]{5,6}$/i,initialize:function(){this.collection.bind("reset",this.render,this);this.render()},render:function(){$(this.el).find("input").val(this.collection.query)},search:function(a){a.preventDefault();this.collection.query=$(this.el).find("input").val();this.collection.query.match(this.webcode)&&(window.location=window.location.origin+window.location.pathname.replace("search/",
this.collection.query));this.collection.type=null;this.collection.date=null;this.collection.start=null;router.navigate(this.collection.nav(),{trigger:!0})}}),DocumentListView=Backbone.View.extend({events:{"click #did-you-mean":"didYouMean"},initialize:function(){this.collection.bind("reset",this.render,this);this.emptyTemplate=_.template(this.options.emptyTemplate.html())},render:function(){var a=$(this.el).empty();$("#search-pagination").show();this.collection.each(function(b){b=new DocumentView({model:b});
a.append(b.render().el)});13>this.collection.count&&$("#search-pagination").hide();0===this.collection.count&&$("<li />").html(this.emptyTemplate()).appendTo($(this.el));this.collection.hasSuggestion()?$('<li id="spellcheck">Meinten Sie: <a href="#"></a>?</li>').prependTo(a).find("a").text(this.collection.getSuggestion()).attr("id","did-you-mean"):$(this.el).find("#spellcheck").detach();return this},didYouMean:function(a){a.preventDefault();$("#search-query").val(this.collection.getSuggestion()).blur()}}),
FilterView=Backbone.View.extend({disableFilter:function(a){a.find("a").hide();a.find("span").detach();$("<span />").text(a.find("a").text()).appendTo(a)},enableFilter:function(a){a.find("span").detach();a.find("a").show()}}),TypeFilterView=FilterView.extend({events:{"click a":"filter"},initialize:function(){this.collection.bind("reset",this.render,this);this.render()},render:function(){$(this.el).find("li").removeClass("main");this.collection.type?$(this.el).find('a[href="#'+this.collection.type+
'"]').closest("li").addClass("main"):$(this.el).find("li").first().addClass("main");var a=this.collection.facets,b=this;$(this.el).find("a").not(":first").each(function(){var c=$(this).attr("href").slice(1);a[c]?b.enableFilter($(this).closest("li")):b.disableFilter($(this).closest("li"))})},filter:function(a){a.preventDefault();this.collection.type=a.target.hash.slice(1);this.collection.start=null;router.navigate(this.collection.nav(),{trigger:!0})}}),DateFilterView=FilterView.extend({events:{"click a":"filter",
"click input[type=submit]":"filterRange"},initialize:function(){this.collection.bind("reset",this.render,this);this.render()},render:function(){$(this.el).find("li").removeClass("main");if(this.collection.date)if(-1===this.collection.date.indexOf(","))$(this.el).find('a[href="#'+this.collection.date+'"]').closest("li").addClass("main");else{var a=this.collection.date.split(",")[0],b=this.collection.date.split(",")[1];a&&$(this.el).find("#range_from").val(a).closest("li").addClass("main");b&&$(this.el).find("#range_to").val(b).closest("li").addClass("main")}else $(this.el).find("li").first().addClass("main")},
filter:function(a){a.preventDefault();$(this.el).find("#range_from").val(null);$(this.el).find("#range_to").val(null);this.collection.date=a.target.hash.slice(1);this.collection.start=null;router.navigate(this.collection.nav(),{trigger:!0})},filterRange:function(a){a.preventDefault();var a=$(this.el).find("input.from").val()||"",b=$(this.el).find("input.to").val()||"";this.collection.date=a||b?[a,b].join():null;this.collection.start=null;router.navigate(this.collection.nav(),{trigger:!0})}}),TopicFilterView=
FilterView.extend({events:{"click a":"filter","click em":"remove"},initialize:function(){this.collection.bind("reset",this.render,this);this.render()},render:function(){$(this.el).find("li").removeClass("main");for(var a=0;a<this.collection.topics.length;a++)$(this.el).find('a[href="#'+this.collection.topics[a]+'"]').closest("li").addClass("main");0===this.collection.topics.length&&$(this.el).find("li:first").addClass("main")},filter:function(a){a.preventDefault();a=a.target.hash.slice(1);""!=a?this.collection.toggleTopic(a):
this.collection.topics=[];this.collection.start=null;router.navigate(this.collection.nav(),{trigger:!0})},remove:function(a){var b=a.target,a=parseInt($(b).attr("id").split("-")[1]),c={};c[a]="false";$.post(this.options.url,{topics:c,format:"json"},function(){$(b).closest("li").detach()},"json")}}),PaginationView=Backbone.View.extend({events:{"click .prev a":"goTo","click .next a":"goTo"},initialize:function(){this.collection.bind("reset",this.render,this)},render:function(){$(this.el).find(".start").text(Math.floor(this.collection.start/
this.collection.rows)+1);$(this.el).find(".end").text(Math.ceil(this.collection.count/this.collection.rows))},goTo:function(a){a.preventDefault();var b=(Math.ceil(this.collection.count/this.collection.rows)-1)*this.collection.rows,a=$(a.target).closest("li").hasClass("prev")?Math.max(0,this.collection.start-this.collection.rows):Math.min(b,this.collection.start+this.collection.rows);a!=this.collection.start&&(this.collection.start=a,router.navigate(this.collection.nav(),{trigger:!0}))}}),TickerFilterView=
FilterView.extend({events:{"click a":"filter"},initialize:function(){this.collection.bind("reset",this.render,this);this.render()},setMain:function(a){$(this.el).find("li").removeClass("main");a?$(this.el).find('a[href="#'+a+'"]').closest("li").addClass("main"):$(this.el).find("li").first().addClass("main")},setInactive:function(a,b){var c=this;$(this.el).find("li").each(function(){var d=$(this).find("a").first().attr("href").slice(1);b in a&&d in a[b]?c.disableFilter($(this)):c.enableFilter($(this))})},
filter:function(a){a.preventDefault();a=$(a.target).attr("href").slice(1);this.collection[this.param]=a?a:null;this.collection.start=null;router.navigate(this.collection.nav(),{trigger:!0})}}),SourceFilterView=TickerFilterView.extend({blacklist:{basel:{twitter:!0},schweiz:{twitter:!0},international:{twitter:!0},sport:{twitter:!0},kultur:{twitter:!0},leben:{twitter:!0},blog:{twitter:!0,agentur:!0,link:!0}},param:"source",render:function(){this.setMain(this.collection.source);this.setInactive(this.blacklist,
this.collection.section)}}),SectionFilterView=TickerFilterView.extend({blacklist:{twitter:{basel:!0,schweiz:!0,international:!0,sport:!0,kultur:!0,leben:!0,blog:!0},agentur:{blog:!0},link:{blog:!0}},param:"section",render:function(){this.setMain(this.collection.section);this.setInactive(this.blacklist,this.collection.source)}}),SortView=Backbone.View.extend({events:{click:"sort"},initialize:function(){this.collection.bind("reset",this.render,this);this.render()},render:function(){this.collection.sortf?
$(this.el).find("a").addClass("desc"):$(this.el).find("a").removeClass("desc");$(this.el).css("cursor","pointer")},sort:function(){this.collection.sortf=this.collection.sortf?null:"latest";this.collection.start=null;router.navigate(this.collection.nav(),{trigger:!0})}}),SearchRouter=Backbone.Router.extend({routes:{"?*params":"search"},search:function(){window.documents.fetch()}});